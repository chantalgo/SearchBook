<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009"
					   xmlns:s="library://ns.adobe.com/flex/spark"
					   xmlns:mx="library://ns.adobe.com/flex/mx"
					   xmlns:ns1="*"
					   creationComplete="windowedapplication1_creationCompleteHandler(event)"
					   width="1024" height="768">
	<fx:Script>
		<![CDATA[
			import com.facebook.graph.FacebookDesktop;
			
			import mx.events.FlexEvent;
			
			import spark.components.Label;
			
			protected function windowedapplication1_creationCompleteHandler(event:FlexEvent):void
			{
				FacebookDesktop.init("279597868748971", loginHandler );
				
			}
			protected function loginHandler(success:Object,fail:Object):void { 
				if(success){ 
					currentState="loggedIn";
					//nameLbl.text=success.user.name;
					//userImg.source=FacebookDesktop.getImageUrl(success.uid,"small");
					//birthdayLbl.text=success.user.birthday;
					//FacebookDesktop.api("/me/statuses",getStatusHandler);
					
				}
			}
			protected function login():void
			{
				FacebookDesktop.login(loginHandler, ["user_birthday","read_stream", "friends_location"]);
				
			}
			protected function logout():void { 
				FacebookDesktop.logout(); 
				currentState="loggedOut";
			}
			/*protected function getStatusHandler(result:Object, fail:Object):void {
				statusLbl.text=result[0].message;
			}*/

			protected function userDisplayFunction(result:Object, fail:Object):void{
					var resultInfo:InformationDisplay;
					var toolTipInfo:String = new String();
					
					if(!(result.location == undefined))
					{
						if(result.location.hasOwnProperty("name"))
						{
							toolTipInfo = result.name + "\n" + result.location.name;
						}
					}
					else{
						toolTipInfo = result.name;
					}
					resultInfo = new InformationDisplay(result.name, "https://facebook.com/" + result.id, FacebookDesktop.getImageUrl(result.id,"small"), toolTipInfo) ;
					peopleResults.addElement(resultInfo);
				
			}
			protected function groupDisplayFunction(result:Object, fail:Object):void{
				var resultInfo:InformationDisplay;
				var toolTipInfo:String = new String();
				
				if(result.hasOwnProperty("description"))
				{
					var des:String = result.description;
					if (des.length > 150)
					{
						toolTipInfo = des.slice(0, 150) + "...";
					}
					else
					{
						toolTipInfo = des;
					}
				}
				else
				{
					toolTipInfo = "(no description)";
				}
				resultInfo = new InformationDisplay(result.name, "https://facebook.com/" + result.id, FacebookDesktop.getImageUrl(result.id,"small"), toolTipInfo);
				groupResults.addElement(resultInfo);
				
			}
			protected function eventDisplayFunction(result:Object, fail:Object):void{
				var resultInfo:InformationDisplay;
				var toolTipInfo:String = new String();
				
				if (result.hasOwnProperty("start_time"))
				{
					var start:String = result.start_time;
					var sdate:String = start.split("T",2)[0];
					var stime:String = start.split("T",2)[1];
					
					
					toolTipInfo += formatDate(sdate) + " " + formatTime(stime) + "\n";	
				}
				if (result.hasOwnProperty("end_time"))
				{
					var end:String = result.end_time;
					var edate:String = end.split("T",2)[0];
					var etime:String = end.split("T",2)[1];
					
					toolTipInfo += formatDate(edate) + " " + formatTime(etime) + "\n"
				}
				if (result.hasOwnProperty("location"))
				{
					toolTipInfo += "Location: " + result.location;
				}
				
				if (toolTipInfo == "")
				{
					toolTipInfo = "no result";
				}
				
				resultInfo = new InformationDisplay(result.name, "https://facebook.com/" + result.id, FacebookDesktop.getImageUrl(result.id,"small"), toolTipInfo) ;
				eventResults.addElement(resultInfo);
				
			}
			protected function pageDisplayFunction(result:Object, fail:Object):void{
				var resultInfo:InformationDisplay;
				var toolTipInfo:String = new String();
				
				if(result.hasOwnProperty("category"))
				{
					toolTipInfo += result.category + "\n";
				}
				if(result.hasOwnProperty("bio"))
				{
					var bio:String = result.bio;
					if (bio.length > 150)
					{
						toolTipInfo += "Bio: " + bio.slice(0, 150) + "...";
					}
					else
					{
						toolTipInfo += "Bio: " + bio;
					}
				}
				
				if (toolTipInfo == "")
				{
					toolTipInfo = "(no description)";
				}
				
				resultInfo = new InformationDisplay(result.name, "https://facebook.com/" + result.id, FacebookDesktop.getImageUrl(result.id,"small"), toolTipInfo) ;
				pageResults.addElement(resultInfo);
				
			}
			
			protected function userSearchResults(result:Object, fail:Object):void {
				var count:int = 0;
				
				
					while (count < 5){
						FacebookDesktop.api(result[count].id, userDisplayFunction);
						count++;
					}		
			}
			protected function groupSearchResults(result:Object, fail:Object):void {
				
				var count:int = 0;

					while (count < 5){
						FacebookDesktop.api(result[count].id, groupDisplayFunction);
						count++;
					}
			}
			protected function eventSearchResults(result:Object, fail:Object):void {
				
				var count:int = 0;

					while (count < 5){
						FacebookDesktop.api(result[count].id, eventDisplayFunction);
						count++;
					}
			}
			protected function pageSearchResults(result:Object, fail:Object):void {
				var count:int = 0;
				

					while (count < 5){
						FacebookDesktop.api(result[count].id, pageDisplayFunction);
						count++;
					}
			}
			
			protected function formatDate(date:String):String
			{
				
				var arr:Array = date.split('-', 3);
				
				var date:String = arr[1] + "/" + arr[2] + "/" + arr[0];
				
				return date;
			}
			
			protected function formatTime(time:String):String
			{
				var arr:Array = time.split(':', 3);
				var hour:int = parseInt(arr[0]);
				var min:int = parseInt(arr[1]);
				var flag:String = "AM";
				
				
				if (hour == 0)
				{
					hour = 12;
				}
				else if (hour >= 12)
				{
					flag = "PM";
					hour -= 12;
				}
				
				if (min < 10)
				{
					return hour + ":" + "0" + min + " " + flag;
				}
				
				return hour + ":" + min + " " + flag;
			}
			
			protected function searchBtn_clickHandler(event:MouseEvent):void
			{
				var tittle:Label = new Label;
				
				switch (radiogroup1.selection) {
					case all :
						this.currentState = "AllSearch";
						peopleResults.removeAllElements();
						groupResults.removeAllElements();
						eventResults.removeAllElements();
						pageResults.removeAllElements();
						tittle.text = "People";
						peopleResults.addElement(tittle);
						var tittle2:Label = new Label;
						tittle2.text = "Groups";
						groupResults.addElement(tittle2);
						var tittle3:Label = new Label;
						tittle3.text = "Events";
						eventResults.addElement(tittle3);
						var tittle4:Label = new Label;
						tittle4.text = "Pages";
						pageResults.addElement(tittle4);
						FacebookDesktop.api("search", userSearchResults, {q:searchBox.text, type:'user'});
						FacebookDesktop.api("search", groupSearchResults, {q:searchBox.text, type:'group'});
						FacebookDesktop.api("search", eventSearchResults, {q:searchBox.text, type:'event'});
						FacebookDesktop.api("search", pageSearchResults, {q:searchBox.text, type:'page'});
						break;
					case people :
						this.currentState = "PeopleSearch";
						peopleResults.removeAllElements();
						tittle.text = "People";
						peopleResults.addElement(tittle);
						FacebookDesktop.api("search", userSearchResults, {q:searchBox.text, type:'user'});
						break;
					case groups :
						this.currentState = "GroupsSearch";
						groupResults.removeAllElements();
						tittle.text = "Groups";
						groupResults.addElement(tittle);
						FacebookDesktop.api("search", groupSearchResults, {q:searchBox.text, type:'group'});
						break;
					case events :
						this.currentState = "EventsSearch";
						eventResults.removeAllElements();
						tittle.text = "Events";
						eventResults.addElement(tittle);
						FacebookDesktop.api("search", eventSearchResults, {q:searchBox.text, type:'event'});
						break;
					case pages :
						this.currentState = "PagesSearch";
						pageResults.removeAllElements();
						tittle.text = "Pages";
						pageResults.addElement(tittle);
						FacebookDesktop.api("search", pageSearchResults, {q:searchBox.text, type:'page'});
						break;
					
				}
				
				
			}
			
			
		]]>
	</fx:Script>
	<s:states>
		<s:State name="loggedOut"/>
		<s:State name="loggedIn"/>
		<s:State name="AllSearch"/>
		<s:State name="PeopleSearch"/>
		<s:State name="GroupsSearch"/>
		<s:State name="EventsSearch"/>
		<s:State name="PagesSearch"/>
	</s:states>
	<fx:Declarations>
		<s:RadioButtonGroup id="radiogroup1"/>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	<s:layout.AllSearch>
		<s:BasicLayout/>
	</s:layout.AllSearch>
	<s:layout.loggedOut>
		<s:BasicLayout/>
	</s:layout.loggedOut>
	<s:layout.PeopleSearch>
		<s:BasicLayout/>
	</s:layout.PeopleSearch>
	<s:layout.GroupsSearch>
		<s:BasicLayout/>
	</s:layout.GroupsSearch>
	<s:layout.EventsSearch>
		<s:BasicLayout/>
	</s:layout.EventsSearch>
	<s:layout.PagesSearch>
		<s:BasicLayout/>
	</s:layout.PagesSearch>
	<s:Form includeIn="EventsSearch,AllSearch,PeopleSearch,PagesSearch,loggedIn,GroupsSearch"
			x="10" y="52" width="266" height="283">
		<s:FormItem width="177"
					width.loggedIn="345">
			<s:layout>
				<s:HorizontalLayout/>
			</s:layout>
			<s:TextInput id="searchBox"/>
			<s:Button id="searchBtn" label="Search" click="searchBtn_clickHandler(event)"/>
		</s:FormItem>
		<s:RadioButton id="all" label="All" groupName="radiogroup1"
					   selected.AllSearch="true"
					   selected.EventsSearch="false"
					   selected.GroupsSearch="false"
					   selected.loggedIn="true"
					   selected.PagesSearch="false"
					   selected.PeopleSearch="false"/>
		<s:RadioButton id="people" label="People" groupName="radiogroup1"
					   selected.AllSearch="false"
					   selected.EventsSearch="false"
					   selected.GroupsSearch="false"
					   selected.loggedIn="false"
					   selected.PagesSearch="false"
					   selected.PeopleSearch="true"/>
		<s:RadioButton id="groups" label="Groups" groupName="radiogroup1"
					   selected.AllSearch="false"
					   selected.EventsSearch="false"
					   selected.GroupsSearch="true"
					   selected.loggedIn="false"
					   selected.PagesSearch="false"
					   selected.PeopleSearch="false"/>
		<s:RadioButton id="events" label="Events" groupName="radiogroup1"
					   selected.AllSearch="false"
					   selected.EventsSearch="true"
					   selected.GroupsSearch="false"
					   selected.loggedIn="false"
					   selected.PagesSearch="false"
					   selected.PeopleSearch="false"/>
		<s:RadioButton id="pages" label="Pages" groupName="radiogroup1" selected="true"
					   selected.AllSearch="false"
					   selected.EventsSearch="false"
					   selected.GroupsSearch="false"
					   selected.loggedIn="false"
					   selected.PagesSearch="true"
					   selected.PeopleSearch="false"/>
	</s:Form>
	<s:Group id="displayGroup"  x="284" y="52" width="730" height="690">
		<ns1:CircleDrawer x="150" y="200" width="52" height="58"/>
		<s:VGroup id="peopleResults" includeIn="AllSearch,PeopleSearch" x="22" y="10" width="200"
				  height="200" horizontalAlign="center"
				  width.PeopleSearch="485" height.PeopleSearch="614">
			
		</s:VGroup>
		<s:VGroup id="groupResults" includeIn="AllSearch,GroupsSearch" x="300" y="10" width="200"
				  height="200" horizontalAlign="center"
				  x.GroupsSearch="24" y.GroupsSearch="10" width.GroupsSearch="517"
				  height.GroupsSearch="624">
			
		</s:VGroup>
		<s:VGroup id="eventResults" includeIn="AllSearch,EventsSearch" x="22" y="510" width="200"
				  height="200" horizontalAlign="center"
				  x.AllSearch="22" y.AllSearch="480"
				  x.EventsSearch="48" y.EventsSearch="17" width.EventsSearch="490"
				  height.EventsSearch="608">
			
		</s:VGroup>
		<s:VGroup id="pageResults" includeIn="AllSearch,PagesSearch" x="300" y="510" width="200"
				  height="200" horizontalAlign="center"
				  x.AllSearch="300" y.AllSearch="480"
				  x.PagesSearch="32" y.PagesSearch="15" width.PagesSearch="545"
				  height.PagesSearch="600">
			
		</s:VGroup>
	</s:Group>
	<s:Image id="searchbooktitleBar" source="assets/searchbook_title.png"
			 x.AllSearch="1" y.AllSearch="1"
			 x.EventsSearch="-1" y.EventsSearch="1"
			 x.GroupsSearch="1" y.GroupsSearch="1"
			 left.loggedIn="1" top.loggedIn="1"
			 x.loggedOut="1" y.loggedOut="-1"
			 x.PagesSearch="0" y.PagesSearch="0"
			 x.PeopleSearch="0" y.PeopleSearch="0"/>
	<s:Button id="loginoutBtn0" includeIn="loggedOut" right="19" top="10" label="Log In"
			  click="login()" skinClass="skins.FBLoginButtonSkin"/>
	<s:Button id="loginoutBtn1" includeIn="loggedIn" right="10" top="13" label="Log Out"
			  click="logout()" skinClass="skins.FBLogoutButtonSkin"/>
	<s:Button id="loginoutBtn2" includeIn="AllSearch" right="10" top="11" label="Log Out"
			  click="logout()" skinClass="skins.FBLogoutButtonSkin"/>
	<s:Button id="loginoutBtn3" includeIn="PeopleSearch" right="10" top="13" label="Log Out"
			  click="logout()" skinClass="skins.FBLogoutButtonSkin"/>
	<s:Button id="loginoutBtn4" includeIn="GroupsSearch" right="10" top="13" label="Log Out"
			  click="logout()" skinClass="skins.FBLogoutButtonSkin"/>
	<s:Button id="loginoutBtn5" includeIn="EventsSearch" right="10" top="12" label="Log Out"
			  click="logout()" skinClass="skins.FBLogoutButtonSkin"/>
	<s:Button id="loginoutBtn" includeIn="PagesSearch" right="10" top="14" label="Log Out"
			  click="logout()" skinClass="skins.FBLogoutButtonSkin"/>
	<mx:LinkButton id="helpLink" label="help"
				   click="navigateToURL(new URLRequest('http://www.cs.columbia.edu/~cg2486/ui/searchbook/user_manual.html'),'User Manual')"
				   color="#FFFFFF" enabled="true" fontFamily="Verdana" textDecoration="underline"
				   right.AllSearch="129" top.AllSearch="12"
				   right.EventsSearch="107" top.EventsSearch="10"
				   right.GroupsSearch="118" top.GroupsSearch="13"
				   right.loggedIn="107" top.loggedIn="11"
				   right.loggedOut="121" top.loggedOut="11"
				   right.PagesSearch="108" top.PagesSearch="12"
				   right.PeopleSearch="109" top.PeopleSearch="13"/>
	
</s:WindowedApplication>
